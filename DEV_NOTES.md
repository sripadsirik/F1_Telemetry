# DEV NOTES - Time Trial Lap Perfection Upgrade

## 1) New `/state` fields

`marco_web.py` now returns these additional analytics fields in `/state` and `session_state` payloads:

- `bin_meta`
  - `count`: number of fixed lap bins (default `320`)
  - `track_length`: reference lap track length in meters
- `reference_bins`: cumulative reference lap time at each bin index
- `current_lap_bins`: cumulative current lap time at bins (live fill)
- `segment_deltas`: live cumulative delta (`current - reference`) per bin
- `last_lap_segment_deltas`: same delta array for the most recently completed valid lap
- `heatmap_points`: XY points aligned to bin indices for track heatmap rendering
- `corner_metrics`: latest lap corner metrics list
- `time_loss_summary`: top-3 corner time losses (`turn`, `delta`, `reason`)
- `corner_mastery`: per-turn mastery rows (`score`, `trend`, `avg_delta`, `consistency_sigma`)
- `consistency`: session consistency metrics
- `driver_profile`: profile `tags` + numeric `stats`
- `skill_scores`: 0-100 skill values
- `optimal_lap`: sector-based and bin-based theoretical lap estimates
- `session_report_summary`: compact summary from latest generated report

The existing core live telemetry fields (`speed`, `gear`, `lap`, `delta`, sectors, laps, fastest, etc.) are unchanged.

## 2) Reference bins model

Location: `marco_core.py` in `F1Coach` helper methods:

- `_build_bin_profile()`
- `_update_live_bin_deltas()`
- `_cumulative_to_segment_times()`
- `_update_optimal_lap()`

Flow:

1. When a new PB/reference lap is set in `_finish_lap()`, Marco builds fixed-distance bins (`HEATMAP_BIN_COUNT`, default `320`) from that lap:
   - `reference_bins`: cumulative time at each distance bin
   - `heatmap_points`: interpolated XY path at same bins
2. During live updates, current lap bins are filled in `_update_live_bin_deltas()`.
3. `segment_deltas` is computed as `current_bin_time - reference_bin_time`.
4. On lap finish, `last_lap_segment_deltas` is generated from completed lap bins.

Fallback behavior:

- If no reference exists yet, bin deltas remain empty.
- If track outline is missing, frontend falls back to current car trail for heatmap drawing.

## 3) Corner segmentation model

Primary source: `TrackAnalyzer` (`marco_core.py`)

- Existing braking/steering-based corner detection is still used.
- Added fallback (`_build_fallback_corners`) when sparse detection occurs:
  - Detect brake-smooth spikes
  - Build corner windows from brake start/end and apex min speed
- Every corner now includes:
  - `start_distance`
  - `apex_distance`
  - `end_distance`
  - `turn_number`

Per-lap corner metrics are computed at lap completion in `_compute_corner_metrics_for_lap()`:

- `entry_speed`
- `apex_speed`
- `exit_speed`
- `brake_point`
- `throttle_point`
- `corner_time`
- `delta_vs_ref`

Real-time corner voice coaching (`_check_corners`) is capped to:

- max 1 callout per corner per lap
- max `MAX_CORNER_CALLOUTS_PER_LAP` callouts per lap

## 4) Tunable thresholds/constants

Main tuning constants are near the top of `marco_core.py`:

- `HEATMAP_BIN_COUNT`
- `CONSISTENCY_WINDOW_LAPS`
- `CORNER_HISTORY_WINDOW`
- `MAX_CORNER_CALLOUTS_PER_LAP`
- `REPORT_INTERVAL_LAPS`

Corner coaching thresholds:

- `BRAKE_POINT_DIFF_M`
- `ENTRY_SPEED_DIFF_KPH`
- `APEX_SPEED_DIFF_KPH`
- `EXIT_SPEED_DIFF_KPH`
- `THROTTLE_POINT_DIFF_M`

Reason-classification and score formulas are implemented in:

- `_infer_corner_reason()`
- `_build_corner_callout()`
- `_update_corner_mastery()`
- `_update_consistency_metrics()`
- `_update_driver_profile()`
- `_update_skill_scores()`
- `_update_optimal_lap()`

## 5) Session report output

Generated by `_generate_performance_report()`:

- `session_data/<session_id>/performance_report.json`
- `session_data/<session_id>/performance_report.md`

Trigger points:

- every `REPORT_INTERVAL_LAPS`
- final session stop

Endpoint:

- `/session/<session_id>/report`
